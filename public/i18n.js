// 多语言翻译数据
const translations = {
  zh: {
    // 首页
    "写作、预览、分享": "写作、预览、分享",
    "输入内容，生成短链接，分享后立即预览。": "输入内容，生成短链接，分享后立即预览。",
    "分享": "分享",
    "编辑区": "编辑区",
    "预览区": "预览区",
    "在这里输入 Markdown...": "在这里输入 Markdown...",
    "分享链接": "分享链接",
    "复制": "复制",
    "生成中...": "生成中...",
    "已复制": "已复制",
    "分享失败": "分享失败",

    // 分享页
    "共享内容预览": "共享内容预览",
    "加载中...": "加载中...",
    "返回编辑器": "返回编辑器",

    // 社交媒体
    "分享到": "分享到",
    "微信": "微信",
    "QQ": "QQ",
    "微博": "微博",
    "Twitter": "Twitter",
    "链接已复制，请在微信中粘贴分享": "链接已复制，请在微信中粘贴分享",
    "复制失败，请手动复制链接": "复制失败，请手动复制链接",
    "查看我的 Markdown 分享": "查看我的 Markdown 分享",

    // 主题切换
    "切换主题": "切换主题",
    "关闭": "关闭"
  },
  en: {
    // 首页
    "写作、预览、分享": "Write, Preview, Share",
    "输入内容，生成短链接，分享后立即预览。": "Enter content, generate short link, preview instantly after sharing.",
    "分享": "Share",
    "编辑区": "Editor",
    "预览区": "Preview",
    "在这里输入 Markdown...": "Type Markdown here...",
    "分享链接": "Share Link",
    "复制": "Copy",
    "生成中...": "Generating...",
    "已复制": "Copied",
    "分享失败": "Share failed",

    // 分享页
    "共享内容预览": "Shared Content Preview",
    "加载中...": "Loading...",
    "返回编辑器": "Back to Editor",

    // 社交媒体
    "分享到": "Share to",
    "微信": "WeChat",
    "QQ": "QQ",
    "微博": "Weibo",
    "Twitter": "Twitter",
    "链接已复制，请在微信中粘贴分享": "Link copied, paste in WeChat to share",
    "复制失败，请手动复制链接": "Copy failed, please copy link manually",
    "查看我的 Markdown 分享": "View my Markdown share",

    // 主题切换
    "切换主题": "Toggle Theme",
    "关闭": "Close"
  },
  ja: {
    // 首页
    "写作、预览、分享": "書く、プレビュー、共有",
    "输入内容，生成短链接，分享后立即预览。": "コンテンツを入力し、短いリンクを生成して、共有後すぐにプレビューします。",
    "分享": "共有",
    "编辑区": "エディター",
    "预览区": "プレビュー",
    "在这里输入 Markdown...": "ここにMarkdownを入力...",
    "分享链接": "共有リンク",
    "复制": "コピー",
    "生成中...": "生成中...",
    "已复制": "コピーしました",
    "分享失败": "共有に失敗しました",

    // 分享页
    "共享内容预览": "共有コンテンツのプレビュー",
    "加载中...": "読み込み中...",
    "返回编辑器": "エディターに戻る",

    // 社交媒体
    "分享到": "共有先",
    "微信": "WeChat",
    "QQ": "QQ",
    "微博": "Weibo",
    "Twitter": "Twitter",
    "链接已复制，请在微信中粘贴分享": "リンクがコピーされました。WeChatで貼り付けて共有してください",
    "复制失败，请手动复制链接": "コピーに失敗しました。リンクを手動でコピーしてください",
    "查看我的 Markdown 分享": "私のMarkdown共有を見る",

    // 主题切换
    "切换主题": "テーマ切り替え",
    "关闭": "閉じる"
  },
  de: {
    // 首页
    "写作、预览、分享": "Schreiben, Vorschau, Teilen",
    "输入内容，生成短链接，分享后立即预览。": "Inhalt eingeben, kurzen Link erstellen, nach dem Teilen sofort vorschauen.",
    "分享": "Teilen",
    "编辑区": "Editor",
    "预览区": "Vorschau",
    "在这里输入 Markdown...": "Markdown hier eingeben...",
    "分享链接": "Teilen-Link",
    "复制": "Kopieren",
    "生成中...": "Wird generiert...",
    "已复制": "Kopiert",
    "分享失败": "Teilen fehlgeschlagen",

    // 分享页
    "共享内容预览": "Vorschau des geteilten Inhalts",
    "加载中...": "Wird geladen...",
    "返回编辑器": "Zurück zum Editor",

    // 社交媒体
    "分享到": "Teilen auf",
    "微信": "WeChat",
    "QQ": "QQ",
    "微博": "Weibo",
    "Twitter": "Twitter",
    "链接已复制，请在微信中粘贴分享": "Link kopiert, fügen Sie ihn in WeChat ein, um zu teilen",
    "复制失败，请手动复制链接": "Kopieren fehlgeschlagen, bitte Link manuell kopieren",
    "查看我的 Markdown 分享": "Meine Markdown-Freigabe ansehen",

    // 主题切换
    "切换主题": "Design umschalten",
    "关闭": "Schließen"
  },
  es: {
    // 首页
    "写作、预览、分享": "Escribir, Previsualizar, Compartir",
    "输入内容，生成短链接，分享后立即预览。": "Ingresa contenido, genera un enlace corto, previsualiza inmediatamente después de compartir.",
    "分享": "Compartir",
    "编辑区": "Editor",
    "预览区": "Vista Previa",
    "在这里输入 Markdown...": "Escribe Markdown aquí...",
    "分享链接": "Enlace de Compartir",
    "复制": "Copiar",
    "生成中...": "Generando...",
    "已复制": "Copiado",
    "分享失败": "Error al compartir",

    // 分享页
    "共享内容预览": "Vista Previa del Contenido Compartido",
    "加载中...": "Cargando...",
    "返回编辑器": "Volver al Editor",

    // 社交媒体
    "分享到": "Compartir en",
    "微信": "WeChat",
    "QQ": "QQ",
    "微博": "Weibo",
    "Twitter": "Twitter",
    "链接已复制，请在微信中粘贴分享": "Enlace copiado, pégalo en WeChat para compartir",
    "复制失败，请手动复制链接": "Error al copiar, por favor copia el enlace manualmente",
    "查看我的 Markdown 分享": "Ver mi Markdown compartido",

    // 主题切换
    "切换主题": "Cambiar Tema",
    "关闭": "Cerrar"
  },
  fr: {
    // 首页
    "写作、预览、分享": "Écrire, Prévisualiser, Partager",
    "输入内容，生成短链接，分享后立即预览。": "Saisissez du contenu, générez un lien court, prévisualisez immédiatement après le partage.",
    "分享": "Partager",
    "编辑区": "Éditeur",
    "预览区": "Aperçu",
    "在这里输入 Markdown...": "Tapez du Markdown ici...",
    "分享链接": "Lien de Partage",
    "复制": "Copier",
    "生成中...": "Génération...",
    "已复制": "Copié",
    "分享失败": "Échec du partage",

    // 分享页
    "共享内容预览": "Aperçu du Contenu Partagé",
    "加载中...": "Chargement...",
    "返回编辑器": "Retour à l'Éditeur",

    // 社交媒体
    "分享到": "Partager sur",
    "微信": "WeChat",
    "QQ": "QQ",
    "微博": "Weibo",
    "Twitter": "Twitter",
    "链接已复制，请在微信中粘贴分享": "Lien copié, collez-le dans WeChat pour partager",
    "复制失败，请手动复制链接": "Échec de la copie, veuillez copier le lien manuellement",
    "查看我的 Markdown 分享": "Voir mon partage Markdown",

    // 主题切换
    "切换主题": "Changer le Thème",
    "关闭": "Fermer"
  },
  pt: {
    // 首页
    "写作、预览、分享": "Escrever, Visualizar, Compartilhar",
    "输入内容，生成短链接，分享后立即预览。": "Insira conteúdo, gere um link curto, visualize imediatamente após compartilhar.",
    "分享": "Compartilhar",
    "编辑区": "Editor",
    "预览区": "Visualização",
    "在这里输入 Markdown...": "Digite Markdown aqui...",
    "分享链接": "Link de Compartilhamento",
    "复制": "Copiar",
    "生成中...": "Gerando...",
    "已复制": "Copiado",
    "分享失败": "Falha ao compartilhar",

    // 分享页
    "共享内容预览": "Visualização do Conteúdo Compartilhado",
    "加载中...": "Carregando...",
    "返回编辑器": "Voltar ao Editor",

    // 社交媒体
    "分享到": "Compartilhar em",
    "微信": "WeChat",
    "QQ": "QQ",
    "微博": "Weibo",
    "Twitter": "Twitter",
    "链接已复制，请在微信中粘贴分享": "Link copiado, cole no WeChat para compartilhar",
    "复制失败，请手动复制链接": "Falha ao copiar, por favor copie o link manualmente",
    "查看我的 Markdown 分享": "Ver meu compartilhamento Markdown",

    // 主题切换
    "切换主题": "Alternar Tema",
    "关闭": "Fechar"
  }
};

// 支持的语言列表
const supportedLangs = [
  { code: 'zh', name: '中文', nativeName: '中文' },
  { code: 'en', name: 'English', nativeName: 'English' },
  { code: 'ja', name: 'Japanese', nativeName: '日本語' },
  { code: 'de', name: 'German', nativeName: 'Deutsch' },
  { code: 'es', name: 'Spanish', nativeName: 'Español' },
  { code: 'fr', name: 'French', nativeName: 'Français' },
  { code: 'pt', name: 'Portuguese', nativeName: 'Português' }
];

// 检测浏览器语言并返回支持的语言代码
function detectLanguage() {
  const browserLang = navigator.language || navigator.userLanguage || 'en';
  // 获取主语言代码（例如 zh-CN -> zh）
  const langCode = browserLang.split('-')[0];
  // 如果浏览器语言被支持，返回它；否则返回英语作为默认
  return translations[langCode] ? langCode : 'en';
}

// 初始化当前语言
let currentLang = localStorage.getItem('language') || detectLanguage();

// 保存语言偏好
function setLanguage(lang) {
  if (translations[lang]) {
    currentLang = lang;
    localStorage.setItem('language', lang);
    return true;
  }
  return false;
}

// 获取翻译文本
function t(key) {
  return translations[currentLang]?.[key] || key;
}

// 更新页面所有需要翻译的文本
function updatePageLanguage() {
  // 更新所有文本节点
  const walker = document.createTreeWalker(
    document.body,
    NodeFilter.SHOW_TEXT,
    null,
    false
  );

  let node;
  while (node = walker.nextNode()) {
    const text = node.textContent.trim();
    if (text && translations[currentLang]?.[text]) {
      node.textContent = translations[currentLang][text];
    }
  }

  // 更新占位符
  document.querySelectorAll('[placeholder]').forEach(el => {
    const placeholder = el.getAttribute('placeholder');
    if (translations[currentLang]?.[placeholder]) {
      el.setAttribute('placeholder', translations[currentLang][placeholder]);
    }
  });

  // 更新aria-label
  document.querySelectorAll('[aria-label]').forEach(el => {
    const ariaLabel = el.getAttribute('aria-label');
    if (translations[currentLang]?.[ariaLabel]) {
      el.setAttribute('aria-label', translations[currentLang][ariaLabel]);
    }
  });

  // 更新HTML lang属性
  document.documentElement.lang = currentLang === 'zh' ? 'zh-CN' : currentLang;
}

// 创建语言选择器
function createLanguageSelector() {
  const selector = document.createElement('select');
  selector.id = 'languageSelector';
  selector.className = 'language-selector';

  supportedLangs.forEach(lang => {
    const option = document.createElement('option');
    option.value = lang.code;
    option.textContent = lang.nativeName;
    if (lang.code === currentLang) {
      option.selected = true;
    }
    selector.appendChild(option);
  });

  selector.addEventListener('change', (e) => {
    setLanguage(e.target.value);
    updatePageLanguage();
  });

  return selector;
}

// 添加语言选择器到页面
function addLanguageSelector() {
  // 如果已经存在，不重复添加
  if (document.getElementById('languageSelector')) {
    return;
  }

  const selector = createLanguageSelector();
  // 添加到主题切换按钮旁边
  const themeToggle = document.getElementById('themeToggle');
  if (themeToggle) {
    themeToggle.parentNode.insertBefore(selector, themeToggle.nextSibling);
  } else {
    // 如果找不到主题切换按钮，添加到main的开始
    const main = document.querySelector('main');
    if (main) {
      main.insertBefore(selector, main.firstChild);
    }
  }
}

// 初始化多语言支持
function initI18n() {
  addLanguageSelector();
  updatePageLanguage();
}

// 导出函数供外部使用
window.I18n = {
  t,
  setLanguage,
  currentLang,
  supportedLangs,
  initI18n
};
